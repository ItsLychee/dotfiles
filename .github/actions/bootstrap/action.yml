name: Setup build environment for Nix
inputs:
  CACHIX_KEY:
    required: true
runs:
  using: "composite"
  steps:
  - uses: actions/checkout@v4
  - name: Install QEMU
    shell: bash
    run: |
        sudo apt update -q -y
        sudo apt install -q -y binfmt-support qemu-efi qemu-system-aarch64 qemu-user-static
  - uses: DeterminateSystems/nix-installer-action@v4
    name: Install Nix
    with:
      extra-conf: |
        extra-platforms = aarch64-linux i686-linux
  - uses: DeterminateSystems/magic-nix-cache-action@main
  - uses: cachix/cachix-action@v14
    name: Setup cachix
    with:
      name: lychee
      authToken: ${{ inputs.CACHIX_KEY }}
      skipAddingSubstituter: 'true'
      installCommand: "nix profile install nixpkgs#cachix"
